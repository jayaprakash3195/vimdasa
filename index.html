<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vimshottari Dasa 5-Level Tree - Modern UI</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    :root {
      --primary: #374785;
      --secondary: #4286f4;
      --accent: #ff9e33;
      --light: #f8f1ff;
      --dark: #203060;
      --text: #333;
      --border: #e2eafe;
      --shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    }
    
    body {
      font-family: 'Latha', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f8f4ff 0%, #f0f7ff 100%);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px 0;
    }
    
    h1 {
      color: var(--dark);
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(to right, #175397, #374785);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .subtitle {
      color: #6f6f82;
      font-size: 1.2rem;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid var(--border);
    }
    
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .input-group {
      flex: 1;
      min-width: 280px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }
    
    input, button {
      font-family: inherit;
      font-size: 1rem;
      border-radius: 10px;
      padding: 12px 15px;
      border: 1px solid #ddd;
      transition: all 0.3s ease;
    }
    
    input {
      width: 100%;
      background: #f9f9ff;
    }
    
    input:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(66, 134, 244, 0.2);
    }
    
    .moon-inputs {
      display: flex;
      gap: 10px;
      margin-top: 5px;
    }
    
    .moon-inputs input {
      text-align: center;
      flex: 1;
    }
    
    button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      padding: 12px 25px;
      min-width: 150px;
      margin-top: 10px;
      box-shadow: 0 4px 6px rgba(55, 71, 133, 0.2);
    }
    
    button:hover {
      background: #2a386b;
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(55, 71, 133, 0.3);
    }
    
    #current {
      background: linear-gradient(to right, #f8f1ff, #f2f4fe);
      border-left: 8px solid var(--primary);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(218, 210, 250, 0.4);
    }
    
    .current-row {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px dashed #e0e0ff;
    }
    
    .current-row:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    
    .level-label {
      font-weight: 700;
      color: var(--dark);
      min-width: 120px;
      font-size: 1.1rem;
    }
    
    .level-value {
      flex: 1;
      font-weight: 600;
      color: var(--primary);
      font-size: 1.1rem;
    }
    
    .dates {
      font-size: 0.9rem;
      color: #6f6f82;
      margin-left: 10px;
      font-weight: normal;
    }
    
    #dasatree-5col-panel {
      display: flex;
      gap: 15px;
      background: #fcfcff;
      border-radius: 16px;
      padding: 25px 15px;
      min-height: 300px;
      box-shadow: 0 3px 14px rgba(219, 231, 255, 0.4);
      overflow-x: auto;
      margin-bottom: 30px;
    }
    
    .treecol {
      flex: 1;
      min-width: 230px;
      background: white;
      border-radius: 14px;
      box-shadow: 0 2px 7px rgba(201, 215, 233, 0.4);
      display: flex;
      flex-direction: column;
      border: 1px solid #f0f0fa;
      transition: transform 0.3s ease;
    }
    
    .treecol:hover {
      transform: translateY(-5px);
    }
    
    .col-head {
      font-weight: 700;
      color: var(--dark);
      background: #f2f4fe;
      text-transform: uppercase;
      padding: 15px 10px;
      font-size: 0.95rem;
      text-align: center;
      border-bottom: 1.4px solid var(--border);
      border-radius: 14px 14px 0 0;
      letter-spacing: 1px;
    }
    
    .dasa-tree-list {
      list-style: none;
      padding: 15px 10px;
      overflow-y: auto;
      flex: 1;
    }
    
    .dasa-tree-list li {
      cursor: pointer;
      border-radius: 8px;
      padding: 12px 15px;
      margin: 8px 0;
      font-size: 1rem;
      transition: all 0.2s ease;
      position: relative;
      text-align: left;
      user-select: none;
      border: 2px solid transparent;
      border-left-width: 8px;
    }
    
    .dasa-tree-list li:hover:not(.selected) {
      background: #f4fbfe;
      border-left-color: #dceaff;
    }
    
    .dasa-tree-dasa.current    { border-left: 8px solid #374785; background: #efeaff; }
    .dasa-tree-puthi.current  { border-left: 8px solid #4286f4; background: #e4f0ff; }
    .dasa-tree-anthara.current{ border-left: 8px solid #ff9e33; background: #fff8ed; }
    .dasa-tree-sutchuma.current { border-left: 8px solid #37cfcf; background: #e6fcfc; }
    .dasa-tree-pranan.current { border-left: 8px solid #67b84b; background: #e9ffe3; }
    
    .dasa-tree-dasa.selected {
      background: #a8a2ea;
      color: #fff !important;
      border: 2px solid #374785;
      font-weight: bold;
    }
    .dasa-tree-puthi.selected {
      background: #6eb1f8;
      color: #fff !important;
      border: 2px solid #4286f4;
      font-weight: bold;
    }
    .dasa-tree-anthara.selected {
      background: #ffc480;
      color: #613f0a !important;
      border: 2px solid #ff9e33;
      font-weight: bold;
    }
    .dasa-tree-sutchuma.selected {
      background: #50e7e7;
      color: #045a5a !important;
      border: 2px solid #37cfcf;
      font-weight: bold;
    }
    .dasa-tree-pranan.selected {
      background: #b9fa9b;
      color: #254915 !important;
      border: 2px solid #67b84b;
      font-weight: bold;
    }
    
    .dasa-tree-list li .dateitem {
      font-size: 0.85rem;
      color: #8c8b99;
      margin-top: 4px;
      display: block;
    }
    
    .instructions {
      background: #f8f9ff;
      border-left: 4px solid var(--secondary);
      padding: 15px 20px;
      border-radius: 10px;
      margin-top: 20px;
      font-size: 0.95rem;
    }
    
    .instructions h3 {
      color: var(--dark);
      margin-bottom: 10px;
    }
    
    .instructions ul {
      padding-left: 20px;
    }
    
    .instructions li {
      margin-bottom: 8px;
    }
    
    @media (max-width: 1200px) {
      #dasatree-5col-panel {
        flex-wrap: wrap;
        justify-content: center;
      }
      .treecol {
        min-width: 45%;
        max-width: 45%;
      }
    }
    
    @media (max-width: 768px) {
      .treecol {
        min-width: 100%;
        max-width: 100%;
      }
      .form-group {
        flex-direction: column;
        gap: 15px;
      }
      h1 {
        font-size: 2rem;
      }
      .subtitle {
        font-size: 1rem;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 15px;
      }
      .card {
        padding: 20px;
      }
      .current-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .level-label {
        margin-bottom: 5px;
      }
      .moon-inputs {
        flex-direction: column;
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>விம்சோத்தரி தசை</h1>
      <p class="subtitle">ஐந்து நிலை தசை மரம் - நவீன இடைமுகம்</p>
    </header>
    
    <div class="card">
      <form onsubmit="event.preventDefault(); run();">
        <div class="form-group">
          <div class="input-group">
            <label for="dob">பிறந்த தேதி:</label>
            <input type="date" id="dob" required />
          </div>
          
          <div class="input-group">
            <label>சந்திரன் நிலை:</label>
            <div class="moon-inputs">
              <input type="number" id="moon_deg" placeholder="பாகை" min="0" max="359" step="1" required />
              <input type="number" id="moon_min" placeholder="நிமிடம்" min="0" max="59" step="1" required />
              <input type="number" id="moon_sec" placeholder="வினாடி" min="0" max="59" step="1" required />
            </div>
          </div>
          
          <div class="input-group">
            <label for="caldate">கணிப்புக்கான தேதி:</label>
            <input type="datetime-local" id="caldate" />
          </div>
        </div>
        
        <div style="text-align: center;">
          <button type="submit">கணக்கிடு</button>
        </div>
      </form>
    </div>
    
    <div id="current"></div>
    
    <div id="dasatree-5col-panel"></div>
    
    <div class="instructions">
      <h3>பயன்பாட்டு வழிமுறைகள்:</h3>
      <ul>
        <li>மேலே உள்ள படிவத்தில் உங்கள் பிறந்த தேதி மற்றும் சந்திரனின் நிலையை உள்ளிடவும்</li>
        <li>கணிக்க விரும்பும் தேதியைத் தேர்ந்தெடுக்கவும் (இல்லையென்றால் தற்போதைய தேதி பயன்படுத்தப்படும்)</li>
        <li>"கணக்கிடு" பொத்தானை அழுத்தவும்</li>
        <li>ஐந்து நிலை தசைகளை மரத்தில் காணலாம் (தசை, புக்தி, அந்தரம், சூட்சுமம், ப்ராணன்)</li>
        <li>நடப்பு காலகட்டம் நீல வண்ணத்தில் காட்டப்பட்டுள்ளது</li>
        <li>ஒவ்வொரு நிலையிலும் உருப்படிகளைக் கிளிக் செய்து தேர்ந்தெடுக்கலாம்</li>
      </ul>
    </div>
  </div>

  <script>
    const PLANETS = ["கேது","சுக்ரன்","சூரியன்","சந்திரன்","செவ்வாய்","ராகு","குரு","சனி","புதன்"];
    const DASA_YEARS = {"கேது":7,"சுக்ரன்":20,"சூரியன்":6,"சந்திரன்":10,"செவ்வாய்":7,"ராகு":18,"குரு":16,"சனி":19,"புதன்":17};
    const NAKS = [
      {name:'அஸ்வினி',lord:'கேது'}, {name:'பரணி',lord:'சுக்ரன்'}, {name:'கிருத்திகை',lord:'சூரியன்'},
      {name:'ரோஹிணி',lord:'சந்திரன்'}, {name:'மிருகசீரிடம்',lord:'செவ்வாய்'}, {name:'திருவாதிரை',lord:'ராகு'},
      {name:'புனர்பூசம்',lord:'குரு'}, {name:'பூசம்',lord:'சனி'}, {name:'ஆயில்யம்',lord:'புதன்'},
      {name:'மகம்',lord:'கேது'}, {name:'பூரம்',lord:'சுக்ரன்'}, {name:'உத்திரம்',lord:'சூரியன்'},
      {name:'ஹஸ்தம்',lord:'சந்திரன்'}, {name:'சித்திரை',lord:'செவ்வாய்'}, {name:'சுவாதி',lord:'ராகு'},
      {name:'விசாகம்',lord:'குரு'}, {name:'அனுஷம்',lord:'சனி'}, {name:'கேட்டை',lord:'புதன்'},
      {name:'மூலம்',lord:'கேது'}, {name:'பூராடம்',lord:'சுக்ரன்'}, {name:'உத்திராடம்',lord:'சூரியன்'},
      {name:'திருவோணம்',lord:'சந்திரன்'}, {name:'அவிட்டம்',lord:'செவ்வாய்'}, {name:'சதயம்',lord:'ராகு'},
      {name:'பூரட்டாதி',lord:'குரு'}, {name:'உத்திரட்டாதி',lord:'சனி'}, {name:'ரேவதி',lord:'புதன்'}
    ];

    function addYears(date, years) {
      const d = new Date(date), y = Math.floor(years), m = (years - y) * 12;
      d.setFullYear(d.getFullYear() + y);
      d.setMonth(d.getMonth() + Math.floor(m));
      d.setDate(d.getDate() + Math.round((m - Math.floor(m)) * 30));
      return d;
    }
    
    function formatDate(dt) {
      if(!dt) return "";
      const y = dt.getFullYear();
      const m = (dt.getMonth()+1).toString().padStart(2,'0');
      const d = dt.getDate().toString().padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    
    function cycle9Nakshatras(start) {
      return Array(9).fill(0).map((_,j) => (start + j) % 27);
    }
    
    function getDasaLordsAndNames(moon) {
      const nakLen = 13 + 20/60;
      const nakIdx = Math.floor(moon / nakLen);
      const startLord = NAKS[nakIdx].lord;
      const startIdx = PLANETS.indexOf(startLord);
      const dasaLords = PLANETS.slice(startIdx).concat(PLANETS.slice(0,startIdx));
      const dasaNakIdxs = Array(9).fill(0).map((_,j) => (nakIdx + j) % 27);
      const dasaNakNames = dasaNakIdxs.map(idx => NAKS[idx].name);
      return {dasaLords, dasaNakIdxs, dasaNakNames, nakIdx};
    }
    
    // Build the five-level Vimshottari tree for current date
    function dasaTree(moon, dob, now) {
      const nakLen = 13 + 20/60;
      const {dasaLords, dasaNakIdxs, dasaNakNames, nakIdx} = getDasaLordsAndNames(moon);
      const offsetDeg = moon - nakIdx * nakLen;
      const balance = 1 - (offsetDeg / nakLen);
      
      // Main Mahadasa starts
      let mdStarts = [], cursor = addYears(dob, -(DASA_YEARS[dasaLords[0]] * (1 - balance)));
      for(let i=0;i<9;i++){ mdStarts[i]=new Date(cursor); cursor=addYears(cursor, DASA_YEARS[dasaLords[i]]); }
      
      const arr = dasaLords.map((lord, i) => ({
        index: i, lord: lord, nak: dasaNakNames[i], nakIdx: dasaNakIdxs[i],
        start: mdStarts[i], end: mdStarts[i+1]||cursor,
        current: now>=mdStarts[i] && now<(mdStarts[i+1]||cursor), puthis:[]
      }));
      
      arr.forEach(md => {
        let puthiNakIdxs = cycle9Nakshatras(md.nakIdx), puthiLords = puthiNakIdxs.map(idx=>NAKS[idx].lord), 
          puthiNakNames = puthiNakIdxs.map(idx=>NAKS[idx].name);
        let mdDuration = (md.end - md.start) / (1000*60*60*24*365.2425);
        let puthiStarts=[], cursorP=new Date(md.start);
        for(let i=0;i<9;i++){ puthiStarts[i]=new Date(cursorP); cursorP=addYears(cursorP, mdDuration*(DASA_YEARS[puthiLords[i]]/120)); }
        
        md.puthis = puthiLords.map((lord, i) => ({
          index: i, lord, nak: puthiNakNames[i], nakIdx: puthiNakIdxs[i],
          start: puthiStarts[i], end: puthiStarts[i+1]||cursorP,
          current: now>=puthiStarts[i] && now<(puthiStarts[i+1]||cursorP), antharas:[]
        }));
        
        md.puthis.forEach(pt => {
          let anthNakIdxs = cycle9Nakshatras(pt.nakIdx), anthLords = anthNakIdxs.map(idx=>NAKS[idx].lord), 
            anthNakNames = anthNakIdxs.map(idx=>NAKS[idx].name);
          let ptDuration = (pt.end - pt.start) / (1000*60*60*24*365.2425);
          let anthStarts=[], cursorA=new Date(pt.start);
          for(let i=0;i<9;i++){ anthStarts[i]=new Date(cursorA); cursorA=addYears(cursorA, ptDuration*(DASA_YEARS[anthLords[i]]/120)); }
          
          pt.antharas = anthLords.map((lord, i) => ({
            index: i, lord, nak: anthNakNames[i], nakIdx: anthNakIdxs[i],
            start: anthStarts[i], end: anthStarts[i+1]||cursorA,
            current: now>=anthStarts[i] && now<(anthStarts[i+1]||cursorA), sutchumas:[]
          }));
          
          pt.antharas.forEach(at => {
            let sutchNakIdxs=cycle9Nakshatras(at.nakIdx),sutchLords=sutchNakIdxs.map(idx=>NAKS[idx].lord),
                sutchNakNames=sutchNakIdxs.map(idx=>NAKS[idx].name);
            let atDuration=(at.end-at.start)/(1000*60*60*24*365.2425);
            let sutchStarts=[], cursorS=new Date(at.start);
            for(let i=0;i<9;i++){ sutchStarts[i]=new Date(cursorS); cursorS=addYears(cursorS, atDuration*(DASA_YEARS[sutchLords[i]]/120)); }
            
            at.sutchumas = sutchLords.map((lord, i) => ({
              index: i, lord, nak: sutchNakNames[i], nakIdx: sutchNakIdxs[i],
              start: sutchStarts[i], end: sutchStarts[i+1]||cursorS,
              current: now>=sutchStarts[i] && now<(sutchStarts[i+1]||cursorS), pranans:[]
            }));
            
            at.sutchumas.forEach(sutch => {
              let prananNakIdxs=cycle9Nakshatras(sutch.nakIdx),prananLords=prananNakIdxs.map(idx=>NAKS[idx].lord),
                prananNakNames=prananNakIdxs.map(idx=>NAKS[idx].name);
              let sutchDuration=(sutch.end-sutch.start)/(1000*60*60*24*365.2425);
              let prananStarts=[], cursorP5=new Date(sutch.start);
              for(let i=0;i<9;i++){ prananStarts[i]=new Date(cursorP5); cursorP5=addYears(cursorP5, sutchDuration*(DASA_YEARS[prananLords[i]]/120)); }
              
              sutch.pranans = prananLords.map((lord, i) => ({
                index: i, lord, nak: prananNakNames[i], nakIdx: prananNakIdxs[i],
                start: prananStarts[i], end: prananStarts[i+1]||cursorP5,
                current: now>=prananStarts[i] && now<(prananStarts[i+1]||cursorP5)
              }));
            });
          });
        });
      });
      return arr;
    }

    let dasaSel=0, puthiSel=-1, anthSel=-1, sutchSel=-1, pranSel=-1;
    let vimData = null;

    const levelNames = {
      dasa: "தசை (Mahadasa)", 
      puthi: "புக்தி (Puthi)", 
      anthara: "அந்தரம் (Anthara)",
      sutchuma: "சூட்சுமா (Sutchuma)", 
      pranan: "ப்ராணன் (Pranan)"
    };

    // List rendering with various highlight modes
    function renderList(items, selIndex, level, onSelectName) {
      return `<div class="col-head">${levelNames[level]}</div>
        <ul class="dasa-tree-list">${
        items.map((p,i)=>{
          let clist = [];
          if (p.current) clist.push('current');
          if (i === selIndex) clist.push('selected');
          return `<li class="dasa-tree-${level} ${clist.join(' ')}" onclick="${onSelectName}(${i})">
            ${p.lord} (${p.nak})<span class="dateitem">${formatDate(p.start)} - ${formatDate(p.end)}</span>
          </li>`;
        }).join('')
      }</ul>`;
    }

    function renderTree5Col() {
      if (!vimData) { 
        document.getElementById('dasatree-5col-panel').innerHTML = '<div class="treecol" style="text-align:center;padding:40px;color:#666;">தசை தகவல்கள் காண்பிக்கப்படும்</div>'; 
        return; 
      }
      
      const col = [];
      col.push(`<div class="treecol">${renderList(vimData,dasaSel,'dasa','selectDasa')}</div>`);
      
      const puthis = vimData[dasaSel]?.puthis || [];
      col.push(`<div class="treecol">${renderList(puthis,puthiSel,'puthi','selectPuthi')}</div>`);
      
      const antharas = puthis[puthiSel]?.antharas || [];
      col.push(`<div class="treecol">${renderList(antharas,anthSel,'anthara','selectAnthara')}</div>`);
      
      const sutchumas = antharas[anthSel]?.sutchumas || [];
      col.push(`<div class="treecol">${renderList(sutchumas,sutchSel,'sutchuma','selectSutchuma')}</div>`);
      
      const pranans = sutchumas[sutchSel]?.pranans || [];
      col.push(`<div class="treecol">${renderList(pranans,pranSel,'pranan','selectPranan')}</div>`);
      
      document.getElementById('dasatree-5col-panel').innerHTML = col.join('');
    }
    
    function selectDasa(i){ dasaSel=i; puthiSel=anthSel=sutchSel=pranSel=-1; renderTree5Col(); updateSummary();}
    function selectPuthi(i){ puthiSel=i; anthSel=sutchSel=pranSel=-1; renderTree5Col(); updateSummary();}
    function selectAnthara(i){ anthSel=i; sutchSel=pranSel=-1; renderTree5Col(); updateSummary();}
    function selectSutchuma(i){ sutchSel=i; pranSel=-1; renderTree5Col(); updateSummary();}
    function selectPranan(i){ pranSel=i; renderTree5Col(); updateSummary();}
    
    window.selectDasa=selectDasa;
    window.selectPuthi=selectPuthi;
    window.selectAnthara=selectAnthara;
    window.selectSutchuma=selectSutchuma;
    window.selectPranan=selectPranan;

    function updateSummary() {
      if(!vimData){ 
        document.getElementById("current").innerHTML=""; 
        return; 
      }
      
      function findCurrentIndex(list){ 
        if(!list) return -1;
        for(let i=0;i<list.length;i++) 
          if(list[i].current) return i; 
        return 0; 
      }
      
      if(dasaSel<0) dasaSel = findCurrentIndex(vimData);
      const dasa = vimData[dasaSel]; 
      if(!dasa){ document.getElementById("current").innerHTML=""; return; }
      
      if(puthiSel<0) puthiSel = findCurrentIndex(dasa.puthis); 
      const puthi = dasa.puthis[puthiSel]; 
      if(!puthi){ document.getElementById("current").innerHTML=""; return; }
      
      if(anthSel<0) anthSel = findCurrentIndex(puthi.antharas); 
      const anthara = puthi.antharas[anthSel]; 
      if(!anthara){ document.getElementById("current").innerHTML=""; return; }
      
      if(sutchSel<0) sutchSel = findCurrentIndex(anthara.sutchumas); 
      const sutchuma = anthara.sutchumas[sutchSel]; 
      if(!sutchuma){ document.getElementById("current").innerHTML=""; return; }
      
      if(pranSel<0) pranSel = findCurrentIndex(sutchuma.pranans); 
      const pranan = sutchuma.pranans[pranSel]; 
      if(!pranan){ document.getElementById("current").innerHTML=""; return; }
      
      dasaSel = dasa.index; 
      puthiSel = puthi.index; 
      anthSel = anthara.index; 
      sutchSel = sutchuma.index; 
      pranSel = pranan.index;
      
      document.getElementById("current").innerHTML = `
        <div class="current-row">
          <div class="level-label">தசை:</div>
          <div class="level-value">${dasa.lord} (${dasa.nak}) <span class="dates">${formatDate(dasa.start)} - ${formatDate(dasa.end)}</span></div>
        </div>
        <div class="current-row">
          <div class="level-label">புக்தி:</div>
          <div class="level-value">${puthi.lord} (${puthi.nak}) <span class="dates">${formatDate(puthi.start)} - ${formatDate(puthi.end)}</span></div>
        </div>
        <div class="current-row">
          <div class="level-label">அந்தரம்:</div>
          <div class="level-value">${anthara.lord} (${anthara.nak}) <span class="dates">${formatDate(anthara.start)} - ${formatDate(anthara.end)}</span></div>
        </div>
        <div class="current-row">
          <div class="level-label">சூட்சுமா:</div>
          <div class="level-value">${sutchuma.lord} (${sutchuma.nak}) <span class="dates">${formatDate(sutchuma.start)} - ${formatDate(sutchuma.end)}</span></div>
        </div>
        <div class="current-row">
          <div class="level-label">ப்ராணன்:</div>
          <div class="level-value">${pranan.lord} (${pranan.nak}) <span class="dates">${formatDate(pranan.start)} - ${formatDate(pranan.end)}</span></div>
        </div>
      `;
    }
    
    function run() {
      const dobStr = document.getElementById("dob").value;
      const mdeg = parseInt(document.getElementById("moon_deg").value) || 0;
      const mmin = parseInt(document.getElementById("moon_min").value) || 0;
      const msec = parseInt(document.getElementById("moon_sec").value) || 0;
      const moon = mdeg + mmin/60 + msec/3600;
      
      if(isNaN(moon) || moon < 0 || moon >= 360){
        alert("சந்திரன் நீளம் சரிபார்க்கவும் (0-359 பாகை).");
        return;
      }
      
      const dob = new Date(dobStr);
      if(isNaN(dob.getTime())){
        alert("பிறந்த தேதி சரிபார்க்கவும்.");
        return;
      }
      
      const caldateStr = document.getElementById("caldate").value;
      const now = caldateStr ? new Date(caldateStr) : new Date();
      
      vimData = dasaTree(moon, dob, now);
      dasaSel = puthiSel = anthSel = sutchSel = pranSel = -1;
      renderTree5Col();
      updateSummary();
    }
    
    // Set default date values for easier testing
    window.onload = function() {
      const today = new Date();
      const dob = new Date(today.getFullYear() - 30, today.getMonth(), today.getDate());
      
      document.getElementById("dob").valueAsDate = dob;
      document.getElementById("moon_deg").value = 120;
      document.getElementById("moon_min").value = 30;
      document.getElementById("moon_sec").value = 0;
      document.getElementById("caldate").valueAsDate = today;
    };
  </script>
</body>
</html>